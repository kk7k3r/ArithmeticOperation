<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Арифметика</title>
</head>
<body>
<div class="container">
    <div id="page1" class="page1">
        <h1 class="h1">Арифметические операции</h1>
        <form id="form1" class="form">
            <label class="inputLabel">Введите ваше ФИО:
                <input class="inputName" type="text" name="name" required>
            </label>
            <label class="inputLabel">Введите кол-во прогонов:
                <input class="inputTries" type="number" step="any" name="tries" required min="1" max="3">
            </label>
            <button type="submit">Далее</button>
        </form>
    </div>
    <div id="page2" class="page2">
        <h2 class="h2">Задача</h2>
        <p class="dividingOnZero" style="font-size: 18px; color: #666;">Обнаружено деление на 0</p>
        <form class="form2" id="form2" action="" method="get">
            <span class="midResult"></span>
            <p class="field">
                <span class="equation"></span>
                &nbsp;=&nbsp;<input class="answer" type="number"><sub class="subValue3">1</sub>
            </p>
            <div style="display: flex; justify-content: center; column-gap: 5px;">
                <button class="btnTry1More" type="submit">Ещё раз</button>
                <button class="btnNext" style="display: none;" type="button">Далее</button>
            </div>
        </form>
    </div>
    <div id="page3" class="page3">
        <h2 class="h2">Результаты</h2>
        <table border="10" id="resultsTable" style="margin-bottom: 10px;">
            <thead>
            <th class="tryNumber">Попытка №</th>
            <th class="userAnswer">Ваш ответ</th>
            <th class="correctAnswer">Правильный ответ</th>
            <th class="result">Результат</th>
            </thead>
            <tbody>
            <tr class="tr1">
                <td class="tdNumber1">1</td>
                <td class="tdAnswer1">0</td>
                <td class="corrAnswer1">0</td>
                <td class="tdResult1">0</td>
            </tr>
            <tr class="tr2" style="display: none;">
                <td class="tdNumber2">2</td>
                <td class="tdAnswer2">0</td>
                <td class="corrAnswer2">0</td>
                <td class="tdResult2">0</td>
            </tr>
            <tr class="tr3" style="display: none;">
                <td class="tdNumber3">3</td>
                <td class="tdAnswer3">0</td>
                <td class="corrAnswer3">0</td>
                <td class="tdResult3">0</td>
            </tr>
            </tbody>
        </table>
        <p>Оценка: <span class="mark"></span></p>
        <form class="form3" action="" method="get" style="display: flex; ">
            <label class="inputLabel" style="display: flex;">
                Напишите комментарий:
                <textarea class="txtArea" name="" id="" cols="30" rows="10"></textarea>
            </label>
            <p class="success-after-save-comment">Файл сохранён</p>
            <button type="submit">Сохранить</button>
        </form>
    </div>
</div>
</body>
<style>

    .container {
        padding: 10px;
        min-height: 170px;
        max-width: 380px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 15%;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .form,
    .form3 {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    #page2,
    #page3 {
        display: none;
    }

    .h1 {
        font-size: 2.5em;
        font-weight: 100;
        color: #292929;
    }

    .inputName {
        width: 40%;
        height: 24px;
        color: #292929;
    }

    .inputTries {
        width: 20%;
        height: 24px;
        color: #292929;
    }

    button {
        margin-top: 2%;
        width: 100px;
        height: 40px;
        margin-left: auto;
        margin-right: auto;
        background: #4078e1;
        color: aliceblue;
        border: #4078e1;
        font-size: 1em;
    }

    .inputLabel {
        font-size: 1.5em;
        font-weight: 100;
        color: #292929;
    }

    .h2 {
        font-size: 2.0em;
        font-weight: 100;
        color: #292929;
    }

    p {
        font-size: 1.5em;
        color: #292929;
    }

    .answer {
        height: 24px;
        color: #292929;
        width: 120px;
    }

    td {
        padding: 10px;
        border: 1px solid #4078e1;
        font-size: 1em;
    }

    table {
        border: 3px solid #4078e1;
        border-collapse: collapse;
        font-size: 1em;
        color: #292929;
    }

    th {
        border: 1px solid #4078e1;
        font-size: 1em;
    }

    .txtArea {
        resize: vertical;
    }

    .success-after-save-comment {
        display: none;
    }

    .dividingOnZero {
        display: none;
    }
</style>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector('.form'),
            form2 = document.querySelector('.form2'),
            form3 = document.querySelector('.form3'),
            page1 = document.querySelector('#page1'),
            page2 = document.querySelector('#page2'),
            page3 = document.querySelector('#page3'),
            inputName = document.querySelector('.inputName'),
            inputTries = document.querySelector('.inputTries'),
            inputAnswer = document.querySelector('.answer'),
            btnTry1More = document.querySelector('.btnTry1More'),
            btnNext = document.querySelector('.btnNext'),
            midResult = document.querySelector('.midResult'),
            equationText = document.querySelector('.equation'),
            subValue3 = document.querySelector('.subValue3'),
            tdAnswer1 = document.querySelector('.tdAnswer1'),
            tdAnswer2 = document.querySelector('.tdAnswer2'),
            tdAnswer3 = document.querySelector('.tdAnswer3'),
            corrAnswer1 = document.querySelector('.corrAnswer1'),
            corrAnswer2 = document.querySelector('.corrAnswer2'),
            corrAnswer3 = document.querySelector('.corrAnswer3'),
            tdResult1 = document.querySelector('.tdResult1'),
            tdResult2 = document.querySelector('.tdResult2'),
            tdResult3 = document.querySelector('.tdResult3'),
            tr2 = document.querySelector('.tr2'),
            tr3 = document.querySelector('.tr3'),
            mark = document.querySelector('.mark'),
            txtArea = document.querySelector('.txtArea'),
            successText = document.querySelector('.success-after-save-comment');

        let name = '';
        let tries = 0;
        let counter = 1;
        let correctAnswer = '';
        let answer1 = '';
        let answer2 = '';
        let answer3 = '';

        let result1 = 0, result2 = 0, result3 = 0

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            name = inputName.value;
            tries = parseInt(inputTries.value);
            // Получаем выражение и ответ с бэка
            const response = await fetch('/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, tries})
            });
            const data = await response.json();
            equationText.innerHTML = data.equation;
            correctAnswer = data.correctAnswer;
            subValue3.textContent = data.base;
            page1.style.display = 'none';
            page2.style.display = 'block';
        });

        form2.addEventListener('submit', async function (e) {
            e.preventDefault();
            let userAnswer = inputAnswer.value;

            if (counter === 1) answer1 = userAnswer;
            if (counter === 2) answer2 = userAnswer;
            if (counter === 3) answer3 = userAnswer;

            const response = await fetch('/check_answer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({answer: userAnswer, correct_answer: correctAnswer})
            });
            const data = await response.json();

            if (counter === 1) result1 = data.correct ? 1 : 0;
            if (counter === 2) result2 = data.correct ? 1 : 0;
            if (counter === 3) result3 = data.correct ? 1 : 0;

            midResult.textContent = data.correct ? 'Правильно' : 'Неправильно';

            if (counter >= tries) {
                btnTry1More.disabled = true;
                btnTry1More.style.background = '#646262';
                btnNext.style.display = 'block';
            }
            counter++;
        });

        btnNext.onclick = function () {
            page2.style.display = 'none';
            page3.style.display = 'block';
            tdAnswer1.textContent = answer1;
            tdAnswer2.textContent = answer2;
            tdAnswer3.textContent = answer3;
            corrAnswer1.textContent = correctAnswer;
            corrAnswer2.textContent = correctAnswer;
            corrAnswer3.textContent = correctAnswer;
            tdResult1.textContent = result1;
            tdResult2.textContent = result2;
            tdResult3.textContent = result3;
            mark.textContent = (result1 || result2 || result3) ? 1 : 0;
            if (tries >= 2) tr2.style.display = 'table-row';
            if (tries >= 3) tr3.style.display = 'table-row';
        };

        form3.addEventListener('submit', function (e) {
            e.preventDefault();
            const commentValue = `${name}: ${txtArea.value}`;
            // Скачиваем комментарий как файл
            var file = new Blob([commentValue], {type: 'txt'});
            var a = document.createElement("a"),
                url = URL.createObjectURL(file);
            a.href = url;
            a.download = 'Комментарий.txt';
            document.body.appendChild(a);
            a.click();
            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
            successText.style.display = 'block';
        });
    });


</script>
</html>